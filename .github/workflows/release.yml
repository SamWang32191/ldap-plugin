name: æ‰‹å‹•ç™¼å¸ƒ Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ç™¼å¸ƒé¡å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'ç™¼å¸ƒèªªæ˜ (é¸å¡«)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¨­ç½® Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: è¨­ç½® Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: è®€å–ç•¶å‰ç‰ˆæœ¬
        id: current_version
        run: |
          CURRENT_VERSION=$(grep "pluginVersion = " gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ç•¶å‰ç‰ˆæœ¬: $CURRENT_VERSION"

      - name: è¨ˆç®—æ–°ç‰ˆæœ¬
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          
          # åˆ†å‰²ç‰ˆæœ¬è™Ÿ
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # æ ¹æ“šç™¼å¸ƒé¡å‹æ›´æ–°ç‰ˆæœ¬è™Ÿ
          case $RELEASE_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          # æ›´æ–° gradle.properties ä¸­çš„ç‰ˆæœ¬è™Ÿ
          sed -i "s/pluginVersion = .*/pluginVersion = $NEW_VERSION/" gradle.properties
          
          echo "ç‰ˆæœ¬è™Ÿå·²æ›´æ–°ç‚º: $NEW_VERSION"

      - name: æ›´æ–° CHANGELOG
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          DATE=$(date +"%Y-%m-%d")
          
          # å‚™ä»½åŸå§‹ CHANGELOG
          cp CHANGELOG.md CHANGELOG.md.bak
          
          # å‰µå»ºæ–°çš„ CHANGELOG å…§å®¹
          {
            echo "# Changelog"
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            echo ""
            if [ -n "$RELEASE_NOTES" ]; then
              echo "$RELEASE_NOTES"
            else
              echo "### è®Šæ›´"
              echo "- ç‰ˆæœ¬æ›´æ–°è‡³ $NEW_VERSION"
            fi
            echo ""
            # æ·»åŠ åŸå§‹å…§å®¹ï¼ˆè·³éç¬¬ä¸€è¡Œæ¨™é¡Œï¼‰
            tail -n +2 CHANGELOG.md.bak
          } > CHANGELOG.md
          
          rm CHANGELOG.md.bak

      - name: å»ºæ§‹å°ˆæ¡ˆ
        run: |
          ./gradlew clean build
          
      - name: åŸ·è¡Œæ¸¬è©¦
        run: |
          ./gradlew test

      - name: å»ºæ§‹æ’ä»¶ç™¼å¸ƒåŒ…
        run: |
          ./gradlew buildPlugin

      - name: æäº¤ç‰ˆæœ¬è®Šæ›´
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add gradle.properties CHANGELOG.md
          git commit -m "chore: ç™¼å¸ƒç‰ˆæœ¬ $NEW_VERSION"
          git push

      - name: å‰µå»º Git æ¨™ç±¤
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
          git push origin "v$NEW_VERSION"

      - name: å‰µå»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.new_version.outputs.new_version }}
          name: ${{ steps.new_version.outputs.new_version }}
          body: |
            ## ğŸš€ Release ${{ steps.new_version.outputs.new_version }}
            
            ### ğŸ“¦ ä¸‹è¼‰
            - [LDAP Manager Plugin](https://github.com/${{ github.repository }}/releases/download/${{ steps.new_version.outputs.new_version }}/LDAP-Manager-${{ steps.new_version.outputs.new_version }}.zip)
            ### ğŸ“‹ è®Šæ›´å…§å®¹
            ${{ github.event.inputs.release_notes || 'ç‰ˆæœ¬æ›´æ–°' }}
            
            ### ğŸ”§ å®‰è£èªªæ˜
            1. ä¸‹è¼‰ `LDAP-Manager-${{ steps.new_version.outputs.new_version }}.zip` æª”æ¡ˆ
            2. åœ¨ IntelliJ IDEA ä¸­ï¼Œå‰å¾€ `File` > `Settings` > `Plugins`
            3. é»æ“Šé½’è¼ªåœ–ç¤ºï¼Œé¸æ“‡ `Install Plugin from Disk...`
            4. é¸æ“‡ä¸‹è¼‰çš„ ZIP æª”æ¡ˆä¸¦å®‰è£
            5. é‡æ–°å•Ÿå‹• IDE
            
            ---
            
            **å®Œæ•´è®Šæ›´æ—¥èªŒ**: https://github.com/${{ github.repository }}/compare/v${{ steps.current_version.outputs.current_version }}...v${{ steps.new_version.outputs.new_version }}
          files: |
            build/distributions/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: ç™¼å¸ƒæ‘˜è¦
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          echo "## ğŸ‰ ç™¼å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ–°ç‰ˆæœ¬**: v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**ç™¼å¸ƒé¡å‹**: ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release é€£çµ**: [æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/v$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ å»ºæ§‹ç”¢ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- LDAP Manager Plugin ZIP æª”æ¡ˆå·²ä¸Šå‚³è‡³ Release" >> $GITHUB_STEP_SUMMARY
